{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h3 class="mb-4">Enter Your Verification Code ({{ couple.s_name }})</h3>

  <form method="post">
    {% csrf_token %}
    <div class="mb-3">
      <label for="code" class="form-label">Verification Code</label>
      <input type="text" class="form-control" name="code" required placeholder="Enter the 6-digit code">
    </div>
    <button type="submit" class="btn btn-success">Verify</button>
  </form>

  <hr>

  <button id="send-code-btn" class="btn btn-outline-primary mt-3">Send me the code</button>
  <div id="code-feedback" class="mt-3 text-info"></div>

  <p class="text-muted mt-3">
    Didnâ€™t receive your code? Please contact Kolajo (08038447001) or Yemisi (08063056070).
  </p>
</div>

<script>
  document.getElementById('send-code-btn').addEventListener('click', function () {
    const button = document.getElementById("send-code-btn");
    button.disabled = true; // Disable the button immediately
    button.innerText = "Sending...";

    fetch("{% url 'send_auth_code' %}", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        uuid: "{{ auth_uuid }}",
        spouse_type: "{{ spouse_type }}"
      })
    })
    .then(response => response.json())
    .then(data => {
      const feedback = document.getElementById('code-feedback');
      feedback.className = data.status === "success" ? "mt-3 text-success" : "mt-3 text-danger";
      feedback.innerText = data.message;

      button.innerText = "Code Sent";
    })
    .catch(error => {
      console.error("Error sending code:", error);
      const feedback = document.getElementById('code-feedback');
      feedback.className = "mt-3 text-danger";
      feedback.innerText = "Something went wrong. Please try again.";
      button.innerText = "Code Sent";
    });
  });
</script>
{% endblock %}
